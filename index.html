<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
                #container {
                    display: flexbox
                }
                .image_display {
                    border: solid 1px;
                    width: 5em;
                    height: 5em;
                }
                #big_image {
                    position: fixed;
                    padding: 5em;
                    max-width: 90vw;
                    max-height: 90vh;
                    width: 50%;
                    height: 50%;
                    object-fit: contain;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                }
            </style>
</head>
    <body>
        <form action="#" method="post">
            <input type="text" name="username" id="username" placeholder="username" autocomplete="off">
            <input type="password" name="password" id="password" placeholder="password">
            <input type="submit" value="login">
        </form>
        <div id="container"></div>
        <img src="" alt="" id="big_image">
        <script>

            Number.prototype.mod = function (n) {
            "use strict";
            return ((this % n) + n) % n;
            };

            let form = document.forms[0]

            let image_file_types = ["jpg", "png", "jpeg"]

            let loaded_images = []

            let big_image = document.getElementById("big_image")
            const container = document.getElementById("container")

            function updateImg(index) {
                big_image.src = loaded_images[index.mod(loaded_images.length)]
            }

            document.onkeydown = e => {
                cursrc = big_image.src

                if (cursrc == document.URL) return

                curidx = loaded_images.indexOf(cursrc)

                switch (e.key.toLowerCase()) {
                    case "escape":
                        big_image.src = ""
                        break
                    case "arrowleft":
                        curidx -= 1
                        updateImg(curidx)
                        break
                    case "arrowright":
                        curidx += 1
                        updateImg(curidx)
                        break
                    case "a":
                        curidx -= 1
                        updateImg(curidx)
                        break
                    case "d":
                        curidx += 1
                        updateImg(curidx)
                        break
                }
            }

            function onFormSubmit(e) {
                e.preventDefault()
                let body = {password: form.password.value, username: form.username.value}
                let req = new XMLHttpRequest()
                req.open("POST", "/")
                req.setRequestHeader("Content-Type", "application/json")
                
                req.onload = () => {
                    let success = req.response == "OK"
                    if (!success) return

                    container.innerHTML = ""

                    getManifest((res)=>{window.manifest = res})
                    let manifest = window.manifest.split("\n")
                    // window.manifest = null

                    for (const item of manifest) {
                        let ext = item.split(".")[1].trim()
                        if (!image_file_types.includes(ext)) continue
                        let el = document.createElement("img")
                        el.classList.add("image_display")
                        el.src = "/files" + item
                        el.alt = `No image: ${item}`

                        loaded_images.push(el.src)

                        // el.onerror = (e) => {
                        //     el = document.createElement("a")
                        //     el.innerText = item
                        // }

                        el.maximized = false
                        el.onclick = e => {
                            big_image.src = el.src
                        }

                        container.appendChild(el)
                    }
                }

                req.send(JSON.stringify(body))
            }

            function updatePage() {
                
            }

            function getManifest(callback) {
                let req = new XMLHttpRequest()
                req.open("GET", "/manifest")

                req.onload = () => {
                    callback(req.responseText)
                }

                req.send()
            }

            form.onsubmit = onFormSubmit
        </script>
    </body>
</html>