<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
                #container {
                    display: flexbox
                }
                .image_display {
                    border: solid 1px;
                    width: 5em;
                    height: 5em;
                    object-fit: cover;
                }
                .video_display {
                    border: solid 1px lime;
                    width: 5em;
                    height: 5em;
                }
                #big_image {
                    border: none;
                    position: fixed;
                    padding: 5em;
                    max-width: 90vw;
                    max-height: 90vh;
                    width: 50%;
                    height: 50%;
                    object-fit: contain;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    pointer-events: none;
                }
                #big_image:not([src]),
                #big_image[src=""] {
                    display: none;
                }

                #big_video {
                    border: none;
                    position: fixed;
                    padding: 5em;
                    max-width: 90vw;
                    max-height: 90vh;
                    width: 50%;
                    height: 50%;
                    object-fit: contain;
                    left: 50%;
                    top: 50%;
                    transform: translate(-50%, -50%);
                    pointer-events: none;
                }
            </style>
</head>
    <body>
        <form action="#" method="post">
            <input type="text" name="username" id="username" placeholder="username" autocomplete="off">
            <input type="password" name="password" id="password" placeholder="password">
            <input type="submit" value="login">
        </form>
        <div id="container"></div>
        <img src="" alt="" id="big_image">
        <video src="" id="big_video"></video>
        <script>

            Number.prototype.mod = function (n) {
            "use strict";
            return ((this % n) + n) % n;
            };

            let form = document.forms[0]

            let image_file_types = ["jpg", "png", "jpeg"]
            let video_file_types = ["mp4"]

            let loaded_images = []

            let big_image = document.getElementById("big_image")
            const container = document.getElementById("container")

            function updateImg(index) {
                loaded = loaded_images[index.mod(loaded_images.length)]
                splt = loaded.split(".")
                ext = splt[splt.length - 1].trim()
                isVideo = video_file_types.includes(ext)
                isImage = image_file_types.includes(ext)
                
                if (isVideo) {
                    big_image.src = ""
                    big_video.src = loaded
                } else if (isImage) {
                    big_video.src = ""
                    big_image.src = loaded
                } else {
                    console.log(loaded, ext, splt, " is neither video nor image ")
                    return
                }
            }

            document.onkeydown = e => {
                cursrc = big_image.src || big_video.src

                if (cursrc == document.URL) return

                curidx = loaded_images.indexOf(cursrc)

                switch (e.key.toLowerCase()) {
                    case "escape":
                        big_image.src = ""
                        big_video.src = ""
                        break
                    case "arrowleft":
                        curidx -= 1
                        updateImg(curidx)
                        break
                    case "arrowright":
                        curidx += 1
                        updateImg(curidx)
                        break
                    case "a":
                        curidx -= 1
                        updateImg(curidx)
                        break
                    case "d":
                        curidx += 1
                        updateImg(curidx)
                        break
                }
            }

            function onFormSubmit(e) {
                e.preventDefault()
                let body = {password: form.password.value, username: form.username.value}
                let req = new XMLHttpRequest()
                req.open("POST", "/")
                req.setRequestHeader("Content-Type", "application/json")
                
                req.onload = () => {
                    let success = req.response == "OK"
                    if (!success) return

                    container.innerHTML = ""

                    getManifest((res)=>{window.manifest = res})
                    let manifest = window.manifest.split("\n")
                    // window.manifest = null

                    for (const item of manifest) {
                        let ext = item.split(".")[1].trim()
                        let el
                        if (image_file_types.includes(ext)) {
                            el = document.createElement("img")
                            el.classList.add("image_display")
                            el.src = "/files" + item
                            el.alt = `No image: ${item}`

                            el.isVideo = false
    
                            loaded_images.push(el.src)
                        } else if (video_file_types.includes(ext)) {
                            el = document.createElement("video")
                            el.classList.add("video_display")
                            el.src = "/files" + item
                            el.alt = `No video: ${item}`

                            el.isVideo = true
    
                            loaded_images.push(el.src)
                        } else {continue}

                        el.onclick = e => {
                            if (!el.isVideo) {
                                big_video.src = ""
                                big_image.src = el.src
                            }
                            else {
                                big_image.src = ""
                                big_video.src = el.src
                            }
                        }

                        container.appendChild(el)
                    }
                }

                req.send(JSON.stringify(body))
            }

            function updatePage() {
                
            }

            function getManifest(callback) {
                let req = new XMLHttpRequest()
                req.open("GET", "/manifest")

                req.onload = () => {
                    callback(req.responseText)
                }

                req.send()
            }

            form.onsubmit = onFormSubmit
        </script>
    </body>
</html>